"use strict";(self.webpackChunkplatformatic_oss_website=self.webpackChunkplatformatic_oss_website||[]).push([[681],{2492:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>c,metadata:()=>l,toc:()=>r});var i=n(4848),s=n(8453);const c={},a="Configure JWT with Keycloak",l={id:"guides/jwt-keycloak",title:"Configure JWT with Keycloak",description:"Keycloak is a open source identity and access management solution that can be integrated with Platformatic DB through JSON Web Tokens (JWT) tokens.",source:"@site/versioned_docs/version-1.53.3/guides/jwt-keycloak.md",sourceDirName:"guides",slug:"/guides/jwt-keycloak",permalink:"/docs/guides/jwt-keycloak",draft:!1,unlisted:!1,editUrl:"https://github.com/platformatic/oss/edit/main/versioned_docs/version-1.53.3/guides/jwt-keycloak.md",tags:[],version:"1.53.3",frontMatter:{},sidebar:"Learn",previous:{title:"Logging to ElasticSearch (or any other destination)",permalink:"/docs/guides/logging-to-elasticsearch"},next:{title:"How to use ENV variables with Platformatic",permalink:"/docs/guides/use-env-with-platformatic"}},o={},r=[{value:"Keycloak Setup",id:"keycloak-setup",level:2},{value:"Setup Realm, Client and Roles",id:"setup-realm-client-and-roles",level:3},{value:"Test the JWT creation",id:"test-the-jwt-creation",level:3},{value:"Platformatic Setup and Test",id:"platformatic-setup-and-test",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"configure-jwt-with-keycloak",children:"Configure JWT with Keycloak"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.keycloak.org/",children:"Keycloak"})," is a open source identity and access management solution that can be integrated with Platformatic DB through ",(0,i.jsx)(t.a,{href:"https://jwt.io/",children:"JSON Web Tokens"})," (JWT) tokens.\nKeycloak is a powerful and complete solution, in this guide we will show how to integate it with Platformatic in a simple case. For more complex scenarios on the Keycloak side, please refer to the latest ",(0,i.jsx)(t.a,{href:"https://www.keycloak.org/documentation.html",children:"Keycloak documentation"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"keycloak-setup",children:"Keycloak Setup"}),"\n",(0,i.jsxs)(t.p,{children:["Start a Keycloak server, ",(0,i.jsx)(t.a,{href:"https://www.keycloak.org/getting-started/getting-started-docker",children:"this can be done using docker"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"docker run -p 8080:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin quay.io/keycloak/keycloak:24.0.2 start-dev\n"})}),"\n",(0,i.jsx)(t.p,{children:"Keep it running in its own terminal."}),"\n",(0,i.jsx)(t.h3,{id:"setup-realm-client-and-roles",children:"Setup Realm, Client and Roles"}),"\n",(0,i.jsxs)(t.p,{children:["Access the Keycloak admin console at ",(0,i.jsx)(t.a,{href:"http://127.0.0.1:8080/auth/admin",children:"http://127.0.0.1:8080/auth/admin"})," and login with the credentials ",(0,i.jsx)(t.code,{children:"admin/admin"}),"."]}),"\n",(0,i.jsx)(t.p,{children:'Now click on the selecton the left and click on "Create realm":'}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Create Realm",src:n(6169).A+"",width:"270",height:"273"})}),"\n",(0,i.jsxs)(t.p,{children:["Name the realm ",(0,i.jsx)(t.code,{children:"plt"}),' and click "Create".']}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Create Realm",src:n(5330).A+"",width:"1397",height:"710"})}),"\n",(0,i.jsx)(t.p,{children:'Now click on the "Clients" tab and click on "Create Client" (clients are\napplications that can authenticate with Keycloak.'}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Create Client",src:n(6271).A+"",width:"865",height:"400"})}),"\n",(0,i.jsxs)(t.p,{children:["Name the client ",(0,i.jsx)(t.code,{children:"keycloak-jwt"}),' and click "Next".']}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Create Client",src:n(1736).A+"",width:"1087",height:"667"})}),"\n",(0,i.jsx)(t.p,{children:'On the "Capability config" set to "ON":'}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Client authentication"}),"\n",(0,i.jsx)(t.li,{children:"Standard flow"}),"\n",(0,i.jsx)(t.li,{children:"Direct access grants"}),"\n",(0,i.jsx)(t.li,{children:"Service account roles"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:'Then click on "Next"'}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Create Client",src:n(2865).A+"",width:"1117",height:"678"})}),"\n",(0,i.jsx)(t.p,{children:'On the "Login settings" set:'}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Valid redirect URIS; ",(0,i.jsx)(t.code,{children:"/*"})]}),"\n",(0,i.jsxs)(t.li,{children:["Web Origins: ",(0,i.jsx)(t.code,{children:"/*"})]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:'Then click on "Save"'}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Create Client",src:n(5150).A+"",width:"1094",height:"733"})}),"\n",(0,i.jsxs)(t.p,{children:['Now in "Clients" select the ',(0,i.jsx)(t.code,{children:"keycloak-jwt"}),' client and click on the "Credentials" tab. Here you can see the client secret, copy it and save it in a safe place.']}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Create Credentials",src:n(2223).A+"",width:"1119",height:"714"})}),"\n",(0,i.jsxs)(t.p,{children:['Now click on the "Roles" tab and create a new role called ',(0,i.jsx)(t.code,{children:"movies:read"})," and save"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Create Realm Role",src:n(6118).A+"",width:"1424",height:"511"})}),"\n",(0,i.jsxs)(t.p,{children:['Go back to the "Clients" tab, select the ',(0,i.jsx)(t.code,{children:"keycloak-jwt"}),' client and click on the "Service Account Roles" tab. Here you can assign the ',(0,i.jsx)(t.code,{children:"movies:read"})," role to the client."]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Assign Role",src:n(856).A+"",width:"1430",height:"529"})}),"\n",(0,i.jsx)(t.h3,{id:"test-the-jwt-creation",children:"Test the JWT creation"}),"\n",(0,i.jsxs)(t.p,{children:["We can use the ",(0,i.jsx)(t.code,{children:"keycloak-jwt"})," client to create a JWT token for the user ",(0,i.jsx)(t.code,{children:"user"})," with the role ",(0,i.jsx)(t.code,{children:"movies:read"}),".\nChange ",(0,i.jsx)(t.code,{children:"YOUR_CLIENT_SECRET"})," with the client secret you saved before."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"  curl -L --insecure -s -X POST 'http://127.0.0.1:8080/realms/plt/protocol/openid-connect/token' \\\n -H 'Content-Type: application/x-www-form-urlencoded' \\\n --data-urlencode 'client_id=keycloak-jwt' \\\n --data-urlencode 'grant_type=client_credentials' \\\n --data-urlencode 'client_secret=YOUR_CLIENT_SECRET'\n"})}),"\n",(0,i.jsx)(t.p,{children:"You should get a response like this:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJLaWhpNVFqRExmWTVOWWtSWmw1QUxvVTgyOFFSMHBXbmJjRk1ya2JpVWdvIn0.eyJleHAiOjE3MTI4Mjk5MzMsImlhdCI6MTcxMjgyOTYzMywianRpIjoiYzJmOWY4NjItZTdlOC00YTcxLThlNzQtNzNiNDIzZWJiNGI2IiwiaXNzIjoiaHR0cDovLzEyNy4wLjAuMTo4MDgwL3JlYWxtcy9wbHQiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiNWIzOWI4ZmUtNDdlOC00ZmYzLTgyOWItYzhjYmNjNWY2OWIxIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoia2V5Y2xvYWstand0IiwiYWNyIjoiMSIsImFsbG93ZWQtb3JpZ2lucyI6WyIvKiJdLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsibW92aWVzOnJlYWQiLCJkZWZhdWx0LXJvbGVzLXBsdCIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6ImVtYWlsIHByb2ZpbGUiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsImNsaWVudEhvc3QiOiIxNzIuMTcuMC4xIiwicHJlZmVycmVkX3VzZXJuYW1lIjoic2VydmljZS1hY2NvdW50LWtleWNsb2FrLWp3dCIsImNsaWVudEFkZHJlc3MiOiIxNzIuMTcuMC4xIiwiY2xpZW50X2lkIjoia2V5Y2xvYWstand0In0.c4sjvdNxw5srjev2KXC4keNoG8SVUOggTCwNFLGOCOo55QNfBeaKb-bGZ4cH5dImkkpgS8940zxf14V7D41xqL6o7FYv4HQOM4E91bqAJrzLr-PUgnzI1GqafgD3ELsA00qMC7_ChaewrbFTR3ROsmn38h_kcMxT_H9YsJLte8GRj_T3EfN1XlEGCRBcZKfx4fZgTMPFcWMOWbd7Xjorp21_hOZzWbk_CNzI4b5UFlzXvU7rcyH2QAgWFqROJl4vt4WIchB8vCc2G5-E2aUzycQJmWZbk6i5Xn01X2cw-3E_qYHnM4eEu-P0TZ9inTl7BFk12zPSMmO62qEGTbB-MQ","expires_in":300,"refresh_expires_in":0,"token_type":"Bearer","not-before-policy":0,"scope":"email profile"}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["You can copy the ",(0,i.jsx)(t.code,{children:"access_token"})," and decode it at ",(0,i.jsx)(t.a,{href:"https://jwt.io/",children:"jwt.io"}),". You shouldobtain a token with a payload like:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{\n  "exp": 1712829933,\n  "iat": 1712829633,\n  "jti": "c2f9f862-e7e8-4a71-8e74-73b423ebb4b6",\n  "iss": "http://127.0.0.1:8080/realms/plt",\n  "aud": "account",\n  "sub": "5b39b8fe-47e8-4ff3-829b-c8cbcc5f69b1",\n  "typ": "Bearer",\n  "azp": "keycloak-jwt",\n  "acr": "1",\n  "allowed-origins": [\n    "/*"\n  ],\n  "realm_access": {\n    "roles": [\n      "movies:read",\n      "default-roles-plt",\n      "offline_access",\n      "uma_authorization"\n    ]\n  },\n  \n  (...)\n\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Note that the token has the role ",(0,i.jsx)(t.code,{children:"movies:read"})," in the ",(0,i.jsx)(t.code,{children:"realm_access"})," section.\nWe will use this token to authenticate with Platformatic DB and the ",(0,i.jsx)(t.code,{children:"movies:read"})," realm role to authorize the user.\nNote that this is a simple example, for instance you might use roles on resources. Refer to ",(0,i.jsx)(t.a,{href:"https://www.keycloak.org/documentation.html",children:"Keycloak documentation"})," for more complex scenarios."]}),"\n",(0,i.jsx)(t.p,{children:"Note also that the access token is valid for 5 minutes (keycloak default)"}),"\n",(0,i.jsx)(t.h2,{id:"platformatic-setup-and-test",children:"Platformatic Setup and Test"}),"\n",(0,i.jsxs)(t.p,{children:["Create a platformatic application using ",(0,i.jsx)(t.code,{children:"npx create-platformatic@latest"}),".\nCall it ",(0,i.jsx)(t.code,{children:"keycloak-test"})," with a ",(0,i.jsx)(t.code,{children:"db-service"}),".\nSpecify to use sqlite and the default migrations:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Create Platformatic",src:n(1040).A+"",width:"1306",height:"976"})}),"\n",(0,i.jsxs)(t.p,{children:["Go to ",(0,i.jsx)(t.code,{children:"keycloak-test/services/db-service"})," folder and open ",(0,i.jsx)(t.code,{children:"platformatic.json"}),".\nAdd the ",(0,i.jsx)(t.code,{children:"authorization"})," section with the ",(0,i.jsx)(t.code,{children:"jwt"})," configuration:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'  "authorization": {\n    "jwt": {\n      "jwks": {\n        "allowedDomains": [\n          "http://127.0.0.1:8080/realms/plt"\n        ],\n        "providerDiscovery": true\n      }\n    },\n    "rolePath": "realm_access.roles",\n    "rules": [\n      {\n        "role": "movies:read",\n        "entity": "movie",\n        "find": true\n      }\n    ]\n  }\n\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Note that the ",(0,i.jsx)(t.code,{children:"rolePath"})," specify the  ",(0,i.jsx)(t.code,{children:"realm_access.roles"})," path in the JWT token that is used to extract the roles from the token.\nThe ",(0,i.jsx)(t.code,{children:"rules"})," section specify that the role ",(0,i.jsx)(t.code,{children:"movies:read"})," can access the ",(0,i.jsx)(t.code,{children:"movie"})," entity with the ",(0,i.jsx)(t.code,{children:"find"})," operation."]}),"\n",(0,i.jsxs)(t.p,{children:["Now go to the ",(0,i.jsx)(t.code,{children:"keycloak-test"})," folder and start the application:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"npm start\n"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Start Platformatic",src:n(2632).A+"",width:"1083",height:"300"})}),"\n",(0,i.jsxs)(t.p,{children:["Test it to invoking the ",(0,i.jsx)(t.code,{children:"movies"})," API. the request MUST be unauthorized:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"curl --request GET \\\n  --url http://127.0.0.1:3042/movies/\n"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Not Authorized",src:n(3757).A+"",width:"1448",height:"117"})}),"\n",(0,i.jsxs)(t.p,{children:["Now you can test to invoke the ",(0,i.jsx)(t.code,{children:"movies"})," API with the JWT token. Keep in mind that the token expires in 5 minutes, so you might need to get a new one."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"\ncurl --location 'http://0.0.0.0:3042/movies' \\\n--header 'Authorization: Bearer YOUR_ACCESS_TOKEN'\n"})}),"\n",(0,i.jsx)(t.p,{children:"Now you should get a response (an empty array in this case, since we have no movies in the database)"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Authorized",src:n(7788).A+"",width:"1635",height:"247"})})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},856:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/assign_service_account_roles-2c93422eaaf35ddacc28c761281a5765.png"},2223:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/client_credentials-ccfed4990298c667a23c9b5551c8686b.png"},6271:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/create_client-206b1eff66270c3c844bfd7ea7cee8f4.png"},1736:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/create_client_2-3d91a2850255329136a61271f51c4e8e.png"},2865:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/create_client_3-ccd6f9f7e6d37c230f0ddf61a09868d9.png"},5150:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/create_client_4-47929f196a4e5516b0da5c3b273672a4.png"},1040:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/create_platformatic-d4db2f58dd47e36423df99a5776ff3c8.png"},6169:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/create_realm-585df005d003dc3d5df99025903fce13.png"},5330:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/create_realm_2-d45a7120ef5f759b2d584767f0e5f0eb.png"},6118:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/create_realm_role-f7c14ba6cb187c48e2af90dfa7ef0131.png"},7788:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/plt_auth-79e13e910c8f85a2cf43c68059e3a16d.png"},2632:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/plt_start-e11c52b41e03bff205c5d513d5135a57.png"},3757:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/plt_unauth-e3cb809f6d6c65e7436bd358de5eb33c.png"},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>l});var i=n(6540);const s={},c=i.createContext(s);function a(e){const t=i.useContext(c);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(c.Provider,{value:t},e.children)}}}]);