"use strict";(self.webpackChunkplatformatic_oss_website=self.webpackChunkplatformatic_oss_website||[]).push([[9939],{8479:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>l});var i=s(4848),o=s(8453);const t={},r="Build and deploy a modular monolith",a={id:"guides/build-modular-monolith",title:"Build and deploy a modular monolith",description:"Introduction",source:"@site/versioned_docs/version-1.53.3/guides/build-modular-monolith.md",sourceDirName:"guides",slug:"/guides/build-modular-monolith",permalink:"/docs/guides/build-modular-monolith",draft:!1,unlisted:!1,editUrl:"https://github.com/platformatic/oss/edit/main/versioned_docs/version-1.53.3/guides/build-modular-monolith.md",tags:[],version:"1.53.3",frontMatter:{},sidebar:"Learn",previous:{title:"Dockerize a Platformatic App",permalink:"/docs/guides/dockerize-platformatic-app"},next:{title:"Logging to ElasticSearch (or any other destination)",permalink:"/docs/guides/logging-to-elasticsearch"}},c={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Create a Platformatic Runtime app: Library app",id:"create-a-platformatic-runtime-app-library-app",level:2},{value:"Start the Library app",id:"start-the-library-app",level:2},{value:"Configure the People service",id:"configure-the-people-service",level:2},{value:"Create the People database schema",id:"create-the-people-database-schema",level:3},{value:"Populate the People database",id:"populate-the-people-database",level:3},{value:"Test the People service",id:"test-the-people-service",level:3},{value:"Create a Platformatic DB service: Books service",id:"create-a-platformatic-db-service-books-service",level:2},{value:"Create the Books database schema",id:"create-the-books-database-schema",level:3},{value:"Populate the Books database",id:"populate-the-books-database",level:3},{value:"Test the Books service API",id:"test-the-books-service-api",level:3},{value:"Create a Platformatic DB service: Movies service",id:"create-a-platformatic-db-service-movies-service",level:2},{value:"Create the Movies database schema",id:"create-the-movies-database-schema",level:3},{value:"Populate the Movies database",id:"populate-the-movies-database",level:3},{value:"Test the Movies service API",id:"test-the-movies-service-api",level:3},{value:"Create a Composer service: Media service",id:"create-a-composer-service-media-service",level:2},{value:"Configure the composed services",id:"configure-the-composed-services",level:3},{value:"Test the composed Media service API",id:"test-the-composed-media-service-api",level:3},{value:"Make the composed Media service API read-only",id:"make-the-composed-media-service-api-read-only",level:3},{value:"Add People data to Media service responses",id:"add-people-data-to-media-service-responses",level:3},{value:"Configure a service proxy to debug the People service API",id:"configure-a-service-proxy-to-debug-the-people-service-api",level:3},{value:"Next steps",id:"next-steps",level:2},{value:"Integrating existing services into a Runtime application",id:"integrating-existing-services-into-a-runtime-application",level:3},{value:"Building Platformatic Runtime services in a monorepo",id:"building-platformatic-runtime-services-in-a-monorepo",level:3},{value:"Wrapping up",id:"wrapping-up",level:2},{value:"Get started with Platformatic",id:"get-started-with-platformatic",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"build-and-deploy-a-modular-monolith",children:"Build and deploy a modular monolith"})}),"\n",(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"In this guide we'll create a \"modular monolith\" Library application. It will be a Platformatic Runtime app which contains multiple Platformatic DB and Composer services. We'll learn how to:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Create and configure a ",(0,i.jsx)(n.a,{href:"https://docs.platformatic.dev/docs/reference/runtime/introduction",children:"Platformatic Runtime"})," app with multiple services","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Three ",(0,i.jsx)(n.a,{href:"https://docs.platformatic.dev/docs/reference/db/introduction",children:"Platformatic DB"})," services, each with their own databases"]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.a,{href:"https://docs.platformatic.dev/docs/reference/composer/introduction",children:"Platformatic Composer"})," service which aggregates multiple service's REST APIs into a composed API"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Customise the composed API that's automatically generated in a Composer service"}),"\n",(0,i.jsx)(n.li,{children:"Generate a client for a service's REST API and use it in a Platformatic service to make API requests"}),"\n",(0,i.jsx)(n.li,{children:"Add custom functionality to a Composer service's composed API by modifying its routes and responses"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The architecture for our Library application will look like this:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Library app architecture diagram",src:s(2165).A+"",width:"1059",height:"678"})}),"\n",(0,i.jsxs)(n.p,{children:["The complete code for this tutorial is ",(0,i.jsx)(n.a,{href:"https://github.com/platformatic/examples/tree/main/applications/build-modular-monolith-with-platformatic",children:"available on GitHub"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"To follow along with this tutorial, you'll need to have this software installed:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://nodejs.org/?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"Node.js"})," >= v18.8.0"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://docs.npmjs.com/cli/?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"npm"})," v7 or later"]}),"\n",(0,i.jsxs)(n.li,{children:["A code editor, for example ",(0,i.jsx)(n.a,{href:"https://code.visualstudio.com/?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"Visual Studio Code"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"create-a-platformatic-runtime-app-library-app",children:"Create a Platformatic Runtime app: Library app"}),"\n",(0,i.jsx)(n.p,{children:"We're going to start by creating our Library app. This will be a Platformatic Runtime app that contains all of our services."}),"\n",(0,i.jsx)(n.p,{children:"First, let's run the Platformatic creator wizard in our terminal:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm create platformatic@latest\n"})}),"\n",(0,i.jsx)(n.p,{children:"And then let's enter the following settings:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Which kind of project do you want to create?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"Runtime"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Where would you like to create your project?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"library-app"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Where would you like to load your services from?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"services"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to run npm install?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"yes"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"After the dependencies have been installed, the creator will prompt us to create a service:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Let's create a first service!\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We're now going to create a Platformatic DB service named ",(0,i.jsx)(n.code,{children:"people-service"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Let's enter the following settings for our new service:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What is the name of the service?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"people-service"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Which kind of project do you want to create?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"DB"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What database do you want to use?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"SQLite"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:'Do you want to use the connection string "sqlite://./db.sqlite"?'}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"y"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to create default migrations?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"yes"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to create a plugin?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"no"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to use TypeScript?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"no"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What port do you want to use?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"3042"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["After answering these questions, the creator will create all of the files for the ",(0,i.jsx)(n.code,{children:"people-service"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Once the creator has finished, our ",(0,i.jsx)(n.code,{children:"library-app"})," directory should look like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"library-app/\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 platformatic.runtime.json\n\u2514\u2500\u2500 services\n    \u2514\u2500\u2500 people-service\n        \u251c\u2500\u2500 README.md\n        \u251c\u2500\u2500 migrations\n        \u2502\xa0\xa0 \u251c\u2500\u2500 001.do.sql\n        \u2502\xa0\xa0 \u2514\u2500\u2500 001.undo.sql\n        \u251c\u2500\u2500 package.json\n        \u2514\u2500\u2500 platformatic.db.json\n"})}),"\n",(0,i.jsx)(n.h2,{id:"start-the-library-app",children:"Start the Library app"}),"\n",(0,i.jsx)(n.p,{children:"Let's change into the directory that contains our Library app:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cd library-app\n"})}),"\n",(0,i.jsx)(n.p,{children:"And then we can start the app with:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm start\n"})}),"\n",(0,i.jsx)(n.p,{children:"We'll see a warning message displayed like this in our terminal:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"[17:56:00.807] WARN (people-service/8615): No tables found in the database. Are you connected to the right database? Did you forget to run your migrations? This guide can help with debugging Platformatic DB: https://docs.platformatic.dev/docs/guides/debug-platformatic-db\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Start the Runtime app - 01",src:s(9061).A+"",width:"3024",height:"663"})}),"\n",(0,i.jsxs)(n.p,{children:["If we open up the API documentation for our People service at ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3042/documentation/",children:"http://127.0.0.1:3042/documentation/"}),", we'll also see that it says ",(0,i.jsx)(n.code,{children:'"No operations defined in spec!"'}),"."]}),"\n",(0,i.jsx)(n.p,{children:"We're seeing these messages because we haven't yet defined a schema for our People database. To fix this, let's go ahead and configure our People service."}),"\n",(0,i.jsx)(n.h2,{id:"configure-the-people-service",children:"Configure the People service"}),"\n",(0,i.jsx)(n.p,{children:"To help us get our People service up and running, we're now going to do the following things:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Create the People database schema"})," \u2014 We'll create an SQL migration that adds the schema for our People database, and then apply it to our database using the Platformatic CLI. When we start our People service, Platformatic DB will automatically generate REST and GraphQL APIs based on our database schema (we'll only be working with the REST one in this tutorial)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Populate the People database"}),' \u2014 We\'ll create a script that can add preset data into our database, and then use the Platformatic CLI to run it. This is commonly referred to as "seeding" the database.']}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Test the People service"})," \u2014 We'll explore the API documentation for our People service, and then make an HTTP request to one of the REST API routes. This will help us verify that our People database has the correct schema and contains the data that we seeded it with."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"create-the-people-database-schema",children:"Create the People database schema"}),"\n",(0,i.jsxs)(n.p,{children:["First, let's open up ",(0,i.jsx)(n.code,{children:"services/people-service/migrations/001.do.sql"})," and replace its contents with this SQL:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"# services/people-service/migrations/001.do.sql\n\nCREATE TABLE IF NOT EXISTS people (\n  id INTEGER PRIMARY KEY,\n  name VARCHAR(255) NOT NULL,\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then let's open up ",(0,i.jsx)(n.code,{children:"services/people-service/migrations/001.undo.sql"})," and replace its contents with this SQL:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"# services/people-service/migrations/001.undo.sql\n\nDROP TABLE people;\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now in another terminal, let's change into the ",(0,i.jsx)(n.code,{children:"people-service"})," directory:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cd services/people-service\n"})}),"\n",(0,i.jsx)(n.p,{children:"And apply our migration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npx platformatic db migrations apply\n"})}),"\n",(0,i.jsx)(n.h3,{id:"populate-the-people-database",children:"Populate the People database"}),"\n",(0,i.jsxs)(n.p,{children:["Let's create a new file, ",(0,i.jsx)(n.code,{children:"services/people-service/seed.js"}),", and add this code to it:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// services/people-service/seed.js\n\n'use strict'\n\nconst people = [\n  'Stephen King',\n  'Miranda July',\n  'Lewis Carroll',\n  'Martha Schumacher',\n  'Mick Garris',\n  'Dede Gardner'\n]\n\nmodule.exports = async function ({ entities, logger }) {\n  for (const name of people) {\n    const newPerson = await entities.person.save({ input: { name } })\n\n    logger.info({ newPerson }, 'Created person')\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then let's add an npm run script which uses the Platformatic CLI to run the seed script to the ",(0,i.jsx)(n.code,{children:"package.json"})," for our People service:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'npm pkg set scripts.seed="platformatic db seed seed.js"\n'})}),"\n",(0,i.jsx)(n.p,{children:"And then let's run it:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run seed\n"})}),"\n",(0,i.jsx)(n.p,{children:"We should see output like this from our seed script:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"[18:06:05] INFO: seeding from seed.js\nCreated person: {\n  id: '1',\n  name: 'Stephen King',\n  createdAt: 1687827965773,\n  updatedAt: 1687827965773\n}\nCreated person: {\n  id: '2',\n  name: 'Miranda July',\n  createdAt: 1687827965778,\n  updatedAt: 1687827965778\n}\n\n...\n\n[18:06:05] INFO: seeding complete\n"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["You can learn more about seeding the database for a Platformatic DB app ",(0,i.jsx)(n.a,{href:"https://docs.platformatic.dev/docs/guides/seed-a-database?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"in this guide"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"test-the-people-service",children:"Test the People service"}),"\n",(0,i.jsxs)(n.p,{children:["Let's refresh the API documentation page for our People service (",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3042/documentation/",children:"http://127.0.0.1:3042/documentation/"}),"). We should now see all of the ",(0,i.jsx)(n.code,{children:"/people"})," API routes that Platformatic DB has automatically generated based on our database schema."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Test the People service - 01",src:s(4148).A+"",width:"3024",height:"1662"})}),"\n",(0,i.jsx)(n.p,{children:"Now we can test our People service API by making a request to it with cURL:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3042/people/\n"})}),"\n",(0,i.jsx)(n.p,{children:"We should receive a response like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'[{"id":1,"name":"Stephen King","createdAt":"1687827965773","updatedAt":"1687827965773"},{"id":2,"name":"Miranda July","createdAt":"1687827965778","updatedAt":"1687827965778"},{"id":3,"name":"Lewis Carroll","createdAt":"1687827965780","updatedAt":"1687827965780"},{"id":4,"name":"Martha Schumacher","createdAt":"1687827965782","updatedAt":"1687827965782"},{"id":5,"name":"Mick Garris","createdAt":"1687827965784","updatedAt":"1687827965784"},{"id":6,"name":"Dede Gardner","createdAt":"1687827965786","updatedAt":"1687827965786"}]\n'})}),"\n",(0,i.jsx)(n.h2,{id:"create-a-platformatic-db-service-books-service",children:"Create a Platformatic DB service: Books service"}),"\n",(0,i.jsx)(n.p,{children:"We're now going to create a Books service. We'll follow a similar process to the one that we just used to set up our People service."}),"\n",(0,i.jsxs)(n.p,{children:["In the root directory of our Runtime project (",(0,i.jsx)(n.code,{children:"library-app"}),"), let's run this command to create the new service:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npx create-platformatic\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then let's enter the following settings:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What is the name of the service?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"books-service"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Which kind of project do you want to create?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"DB"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What database do you want to use?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"SQLite"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:'Do you want to use the connection string "sqlite://./db.sqlite"?'}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"y"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to create default migrations?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"yes"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to create a plugin?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"no"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to use TypeScript?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"no"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What port do you want to use?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"3043"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to apply migrations?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"no"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to generate types?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"yes"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Once the command has finished running, we should see that a Platformatic DB service has been created for us in the ",(0,i.jsx)(n.code,{children:"services/books-service/"})," directory."]}),"\n",(0,i.jsx)(n.h3,{id:"create-the-books-database-schema",children:"Create the Books database schema"}),"\n",(0,i.jsx)(n.p,{children:"Now we're going to create a migration that adds the schema for our Books database."}),"\n",(0,i.jsxs)(n.p,{children:["First, let's open up ",(0,i.jsx)(n.code,{children:"services/books-service/migrations/001.do.sql"})," and replace its contents with this SQL:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"# services/books-service/migrations/001.do.sql\n\nCREATE TABLE IF NOT EXISTS books (\n  id INTEGER PRIMARY KEY,\n  title VARCHAR(255) NOT NULL,\n  author_id INTEGER NOT NULL,\n  published_year INTEGER NOT NULL,\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then let's open up ",(0,i.jsx)(n.code,{children:"services/books-service/migrations/001.undo.sql"})," and replace its contents with this SQL:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"# services/books-service/migrations/001.undo.sql\n\nDROP TABLE books;\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now we'll change into the ",(0,i.jsx)(n.code,{children:"books-service"})," directory:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cd services/books-service\n"})}),"\n",(0,i.jsx)(n.p,{children:"And apply our migration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npx platformatic db migrations apply\n"})}),"\n",(0,i.jsx)(n.h3,{id:"populate-the-books-database",children:"Populate the Books database"}),"\n",(0,i.jsxs)(n.p,{children:["Let's create a new file, ",(0,i.jsx)(n.code,{children:"services/books-service/seed.js"}),", and add this code to it:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// services/books-service/seed.js\n\n'use strict'\n\nconst books = [\n  {\n    title: 'Fairy Tale',\n    authorId: 1, // Stephen King\n    publishedYear: '2022'\n  },\n  {\n    title: 'No One Belongs Here More Than You',\n    authorId: 2, // Miranda July\n    publishedYear: 2007\n  },\n  {\n    title: 'Alice\\'s Adventures in Wonderland',\n    authorId: 3, // Lewis Carroll\n    publishedYear: 1865\n  }\n]\n\nmodule.exports = async function ({ entities, logger }) {\n  for (const book of books) {\n    const newBook = await entities.book.save({ input: book })\n\n    logger.info({ newBook }, 'Created book')\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then let's add an npm run script which uses the Platformatic CLI to run the seed script to the ",(0,i.jsx)(n.code,{children:"package.json"})," for our Books service:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'npm pkg set scripts.seed="platformatic db seed seed.js"\n'})}),"\n",(0,i.jsx)(n.p,{children:"And then let's run it:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run seed\n"})}),"\n",(0,i.jsx)(n.p,{children:"We should see output like this from our seed script:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"[12:13:31] INFO: seeding from seed.js\nCreated book: {\n  id: '1',\n  title: 'Fairy Tale',\n  authorId: 1,\n  publishedYear: 2022,\n  createdAt: 1687893211326,\n  updatedAt: 1687893211326\n}\n\n...\n\n[12:13:31] INFO: seeding complete\n"})}),"\n",(0,i.jsx)(n.h3,{id:"test-the-books-service-api",children:"Test the Books service API"}),"\n",(0,i.jsxs)(n.p,{children:["To publicly expose the Books service so that we can test it, we need to change the ",(0,i.jsx)(n.code,{children:"entrypoint"})," in ",(0,i.jsx)(n.code,{children:"platformatic.runtime.json"})," to ",(0,i.jsx)(n.code,{children:"books-service"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'// platformatic.runtime.json\n\n{\n  "$schema": "https://platformatic.dev/schemas/v0.27.0/runtime",\n  "entrypoint": "books-service",\n  ...\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In the terminal where we have our Library app running, let's stop it by pressing ",(0,i.jsx)(n.code,{children:"CTRL+C"}),". Then let's start it again with:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm start\n"})}),"\n",(0,i.jsx)(n.p,{children:"Now we can test our Books service API by making a request to it:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3043/books/\n"})}),"\n",(0,i.jsx)(n.p,{children:"The response should look like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'[{"id":1,"title":"Fairy Tale","authorId":1,"publishedYear":2022,"createdAt":"1687893211326","updatedAt":"1687893211326"},{"id":2,"title":"No One Belongs Here More Than You","authorId":2,"publishedYear":2007,"createdAt":"1687893211333","updatedAt":"1687893211333"},{"id":3,"title":"Alice\'s Adventures in Wonderland","authorId":3,"publishedYear":1865,"createdAt":"1687893211336","updatedAt":"1687893211336"}]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["If we open up the API documentation for our Books service at ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3043/documentation/",children:"http://127.0.0.1:3043/documentation/"}),", we can see all of its routes:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Test the Books Service API 01",src:s(5240).A+"",width:"3024",height:"1662"})}),"\n",(0,i.jsx)(n.h2,{id:"create-a-platformatic-db-service-movies-service",children:"Create a Platformatic DB service: Movies service"}),"\n",(0,i.jsx)(n.p,{children:"We're now going to create our third and final Platformatic DB service: the Movies service."}),"\n",(0,i.jsxs)(n.p,{children:["In the root directory of our Runtime project (",(0,i.jsx)(n.code,{children:"library-app"}),"), let's create the new service:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npx create-platformatic\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then let's enter the following settings:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What is the name of the service?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"movies-service"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Which kind of project do you want to create?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"DB"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What database do you want to use?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"SQLite"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:'Do you want to use the connection string "sqlite://./db.sqlite"?'}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"y"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to create default migrations?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"yes"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to create a plugin?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"no"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to use TypeScript?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"no"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What port do you want to use?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"3044"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to apply migrations?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"no"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Do you want to generate types?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"yes"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Similarly to before, once the command has finished running, we should see that a Platformatic DB service has been created for us in the ",(0,i.jsx)(n.code,{children:"services/movies-service/"})," directory."]}),"\n",(0,i.jsx)(n.h3,{id:"create-the-movies-database-schema",children:"Create the Movies database schema"}),"\n",(0,i.jsx)(n.p,{children:"Lets create a migration to add the schema for our Movies database."}),"\n",(0,i.jsxs)(n.p,{children:["First, we'll open up ",(0,i.jsx)(n.code,{children:"services/movies-service/migrations/001.do.sql"})," and replace its contents with this SQL:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"# services/movies-service/migrations/001.do.sql\n\nCREATE TABLE IF NOT EXISTS movies (\n  id INTEGER PRIMARY KEY,\n  title VARCHAR(255) NOT NULL,\n  director_id INTEGER NOT NULL,\n  producer_id INTEGER NOT NULL,\n  released_year INTEGER NOT NULL,\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then let's open up ",(0,i.jsx)(n.code,{children:"services/movies-service/migrations/001.undo.sql"})," and replace its contents with this SQL:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"# services/movies-service/migrations/001.undo.sql\n\nDROP TABLE movies;\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now we'll change into the ",(0,i.jsx)(n.code,{children:"movies-service"})," directory:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cd services/movies-service\n"})}),"\n",(0,i.jsx)(n.p,{children:"And apply our migration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npx platformatic db migrations apply\n"})}),"\n",(0,i.jsx)(n.h3,{id:"populate-the-movies-database",children:"Populate the Movies database"}),"\n",(0,i.jsxs)(n.p,{children:["Let's create a new file, ",(0,i.jsx)(n.code,{children:"services/movies-service/seed.js"}),", and add this code to it:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// services/movies-service/seed.js\n\n'use strict'\n\nconst movies = [\n  {\n    title: 'Maximum Overdrive',\n    directorId: 1, // Stephen King\n    producerId: 4, // Martha Schumacher\n    releasedYear: 1986\n  },\n  {\n    title: 'The Shining',\n    directorId: 5, // Mick Garris\n    producerId: 1, // Stephen King\n    releasedYear: 1980\n  },\n  {\n    title: 'Kajillionaire',\n    directorId: 2, // Miranda July\n    producerId: 6, // Dede Gardner\n    releasedYear: 2020\n  }\n]\n\nmodule.exports = async function ({ entities, logger }) {\n  for (const movie of movies) {\n    const newmovie = await entities.movie.save({ input: movie })\n\n    logger.info({ newmovie }, 'Created movie')\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then let's add an npm run script which uses the Platformatic CLI to run the seed script to the ",(0,i.jsx)(n.code,{children:"package.json"})," for our Movies service:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'npm pkg set scripts.seed="platformatic db seed seed.js"\n'})}),"\n",(0,i.jsx)(n.p,{children:"And then let's run it:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run seed\n"})}),"\n",(0,i.jsx)(n.p,{children:"We should see output like this from our script:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"[12:43:24] INFO: seeding from seed.js\nCreated movie: {\n  id: '1',\n  title: 'Maximum Overdrive',\n  directorId: 1,\n  producerId: 4,\n  releasedYear: 1986,\n  createdAt: 1687895004362,\n  updatedAt: 1687895004362\n}\n\n...\n\n[12:43:24] INFO: seeding complete\n"})}),"\n",(0,i.jsx)(n.h3,{id:"test-the-movies-service-api",children:"Test the Movies service API"}),"\n",(0,i.jsxs)(n.p,{children:["Let's change the ",(0,i.jsx)(n.code,{children:"entrypoint"})," in ",(0,i.jsx)(n.code,{children:"platformatic.runtime.json"})," to ",(0,i.jsx)(n.code,{children:"movies-service"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'// platformatic.runtime.json\n\n{\n  "$schema": "https://platformatic.dev/schemas/v0.27.0/runtime",\n  "entrypoint": "movies-service",\n  ...\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["And then let's stop our Library app running by pressing ",(0,i.jsx)(n.code,{children:"CTRL+C"}),", and start it again with:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm start\n"})}),"\n",(0,i.jsx)(n.p,{children:"We can now test our Movies service API by making a request to it:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3044/movies/\n"})}),"\n",(0,i.jsx)(n.p,{children:"And we should then receive a response like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'[{"id":1,"title":"Maximum Overdrive","directorId":1,"producerId":4,"releasedYear":1986,"createdAt":"1687895004362","updatedAt":"1687895004362"},{"id":2,"title":"The Shining","directorId":5,"producerId":1,"releasedYear":1980,"createdAt":"1687895004369","updatedAt":"1687895004369"},{"id":3,"title":"Kajillionaire","directorId":2,"producerId":6,"releasedYear":2020,"createdAt":"1687895004372","updatedAt":"1687895004372"}]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["If we open up the Swagger UI documentation at ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3044/documentation/",children:"http://127.0.0.1:3044/documentation/"}),", we can see all of our Movie service's API routes:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Test the Movies service API - 01",src:s(2500).A+"",width:"3024",height:"1662"})}),"\n",(0,i.jsx)(n.h2,{id:"create-a-composer-service-media-service",children:"Create a Composer service: Media service"}),"\n",(0,i.jsxs)(n.p,{children:["We're now going to use Platformatic Composer to create a Media service. This service will compose the ",(0,i.jsx)(n.code,{children:"books-service"})," and ",(0,i.jsx)(n.code,{children:"movies-service"})," APIs into a single REST API."]}),"\n",(0,i.jsxs)(n.p,{children:["In the root directory of our Runtime project (",(0,i.jsx)(n.code,{children:"library-app"}),"), let's create the Media service by running:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npx create-platformatic\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then let's enter the following settings:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What is the name of the service?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"media-service"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Which kind of project do you want to create?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"Composer"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"What port do you want to use?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"3045"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Once the command has finished, we'll see that our Platformatic Composer service has been created in the ",(0,i.jsx)(n.code,{children:"services/media-service"})," directory."]}),"\n",(0,i.jsx)(n.h3,{id:"configure-the-composed-services",children:"Configure the composed services"}),"\n",(0,i.jsxs)(n.p,{children:["We're now going to replace the example ",(0,i.jsx)(n.code,{children:"services"})," configuration for our Media service, and configure it to compose the APIs for our Books and Movies services."]}),"\n",(0,i.jsxs)(n.p,{children:["Let's open up ",(0,i.jsx)(n.code,{children:"services/media-service/platformatic.composer.json"})," and replace the ",(0,i.jsx)(n.code,{children:"services"})," array so that it looks like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'// services/media-service/platformatic.composer.json\n\n{\n  "$schema": "https://platformatic.dev/schemas/v0.27.0/composer",\n  ...,\n  "composer": {\n    "services": [\n      {\n        "id": "books-service",\n        "openapi": {\n          "url": "/documentation/json"\n        }\n      },\n      {\n        "id": "movies-service",\n        "openapi": {\n          "url": "/documentation/json"\n        }\n      }\n    ],\n    "refreshTimeout": 1000\n  },\n  ...\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Let's take a look at the settings we've added here:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"composer.services[].id"})," \u2014 The ",(0,i.jsx)(n.code,{children:"id"})," values are the identifiers for our Books and Movies services. These are derived from the services' directory names."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"composer.services[].openapi.url"})," \u2014 This is the URL that Composer will automatically call to retrieve the service's OpenAPI schema. It will use the OpenAPI schema to build the routes in our Media service's composed API."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"composer.refreshTimeout"})," \u2014 This configures Composer to retrieve the OpenAPI schema for each service every 1 second (1000 milliseconds = 1 second). This is a good value during development, but should be longer in production. If Composer detects that the OpenAPI schema for a service has changed, it will rebuild the composed API."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"test-the-composed-media-service-api",children:"Test the composed Media service API"}),"\n",(0,i.jsxs)(n.p,{children:["To expose our Media service, let's change the ",(0,i.jsx)(n.code,{children:"entrypoint"})," in ",(0,i.jsx)(n.code,{children:"platformatic.runtime.json"})," to ",(0,i.jsx)(n.code,{children:"media-service"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'// platformatic.runtime.json\n\n{\n  "$schema": "https://platformatic.dev/schemas/v0.27.0/runtime",\n  "entrypoint": "media-service",\n  ...\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["And then stop (",(0,i.jsx)(n.code,{children:"CTRL+C"}),") and start our Library app:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm start\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now let's open up the Media service's API documentation at ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3045/documentation/",children:"http://127.0.0.1:3045/documentation/"}),". Here we can see that our Media service is composing all of our Books and Movie services' API routes into a single REST API:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Test the Composed Media Service API - 01",src:s(3919).A+"",width:"3024",height:"1814"})}),"\n",(0,i.jsx)(n.p,{children:"Now let's test our composed Media service API by making a request to retrieve books:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3045/books/\n"})}),"\n",(0,i.jsx)(n.p,{children:"We should receive a response like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'[{"id":1,"title":"Fairy Tale","authorId":1,"publishedYear":2022,"createdAt":"1687893211326","updatedAt":"1687893211326"},{"id":2,"title":"No One Belongs Here More Than You","authorId":2,"publishedYear":2007,"createdAt":"1687893211333","updatedAt":"1687893211333"},{"id":3,"title":"Alice\'s Adventures in Wonderland","authorId":3,"publishedYear":1865,"createdAt":"1687893211336","updatedAt":"1687893211336"}]\n'})}),"\n",(0,i.jsx)(n.p,{children:"And then we can make a request to retrieve movies through the Media service API:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3045/movies/\n"})}),"\n",(0,i.jsx)(n.p,{children:"We should receive a response like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'[{"id":1,"title":"Maximum Overdrive","directorId":1,"producerId":4,"releasedYear":1986,"createdAt":"1687895004362","updatedAt":"1687895004362"},{"id":2,"title":"The Shining","directorId":5,"producerId":1,"releasedYear":1980,"createdAt":"1687895004369","updatedAt":"1687895004369"},{"id":3,"title":"Kajillionaire","directorId":2,"producerId":6,"releasedYear":2020,"createdAt":"1687895004372","updatedAt":"1687895004372"}]\n'})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"If Composer has already generated a composed API, but later is unable to retrieve the OpenAPI schema for a service, it will remove the routes for that service from the composed API. Those routes will then return a 404 error response."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"make-the-composed-media-service-api-read-only",children:"Make the composed Media service API read-only"}),"\n",(0,i.jsx)(n.p,{children:"Platformatic Composer allows us to customise the composed API that it generates for us. We can do this by creating an OpenAPI configuration file for each service, and then configuring our Composer service to load it."}),"\n",(0,i.jsxs)(n.p,{children:["Our Books and Movies databases are already populated with data, and we don't want anyone to be able to add to, edit or delete that data. We're now going to configure the Media service to ignore ",(0,i.jsx)(n.code,{children:"POST"}),", ",(0,i.jsx)(n.code,{children:"PUT"})," and ",(0,i.jsx)(n.code,{children:"DELETE"})," routes for the Books and Movies APIs. This will effectively make our Media service's composed API read-only."]}),"\n",(0,i.jsxs)(n.p,{children:["First, let's create a new file, ",(0,i.jsx)(n.code,{children:"services/media-service/books-service-openapi.config.json"}),", and add in this JSON:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'// services/media-service/books-service-openapi.config.json\n\n{\n  "paths": {\n    "/books/": {\n      "post": { "ignore": true },\n      "put": { "ignore": true },\n      "delete": { "ignore": true }\n    },\n    "/books/{id}": {\n      "post": { "ignore": true },\n      "put": { "ignore": true },\n      "delete": { "ignore": true }\n    }\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Then let's create another file, ",(0,i.jsx)(n.code,{children:"services/media-service/movies-service-openapi.config.json"}),", and add in this JSON:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'// services/media-service/movies-service-openapi.config.json\n\n{\n  "paths": {\n    "/movies/": {\n      "post": { "ignore": true },\n      "put": { "ignore": true },\n      "delete": { "ignore": true }\n    },\n    "/movies/{id}": {\n      "post": { "ignore": true },\n      "put": { "ignore": true },\n      "delete": { "ignore": true }\n    }\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Now let's open up ",(0,i.jsx)(n.code,{children:"services/media-service/platformatic.composer.json"})," and configure the Media service to apply these service configurations to our composed API:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:'// services/media-service/platformatic.composer.json\n\n  {\n    "$schema": "https://platformatic.dev/schemas/v0.27.0/composer",\n    ...,\n    "composer": {\n      "services": [\n        {\n          "id": "books-service",\n          "openapi": {\n-           "url": "/documentation/json"\n+           "url": "/documentation/json",\n+           "config": "books-service-openapi.config.json"\n          }\n        },\n        {\n          "id": "movies-service",\n          "openapi": {\n-           "url": "/documentation/json"\n+           "url": "/documentation/json",\n+           "config": "movies-service-openapi.config.json"\n          }\n        }\n      ],\n      "refreshTimeout": 1000\n    },\n    ...\n  }\n'})}),"\n",(0,i.jsxs)(n.p,{children:["If we open up the API documentation for our Media service at ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3045/documentation/",children:"http://127.0.0.1:3045/documentation/"}),", we should now see that only the composed ",(0,i.jsx)(n.code,{children:"GET"})," routes are available:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Make the Composed Media Service API Read Only - 01",src:s(6545).A+"",width:"3024",height:"1095"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["As well as allowing us to ignore specific routes, Platformatic Composer also supports aliasing for route paths and the renaming of route response fields. See the ",(0,i.jsx)(n.a,{href:"https://docs.platformatic.dev/docs/reference/composer/configuration?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog#openapi-configuration",children:"Composer OpenAPI"})," documentation to learn more."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"add-people-data-to-media-service-responses",children:"Add People data to Media service responses"}),"\n",(0,i.jsxs)(n.p,{children:["Our Books and Media services currently send responses containing IDs that relate to people in the People database, but those responses don't contain the names of those people. We're now going to create a client for the People service, and then create a plugin for our Media service that uses it to enrich the Books and Movies service responses with people's names. The responses from the ",(0,i.jsx)(n.code,{children:"/books/"})," and ",(0,i.jsx)(n.code,{children:"/movies/"})," routes in our Media service's composed API will then contain IDs ",(0,i.jsx)(n.em,{children:"and"})," names for the people that each resource relates to."]}),"\n",(0,i.jsx)(n.p,{children:"First, let's change into the directory for our Media service:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cd services/media-service/\n"})}),"\n",(0,i.jsxs)(n.p,{children:["And then let's install ",(0,i.jsx)(n.a,{href:"https://www.npmjs.com/package/@platformatic/client?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:(0,i.jsx)(n.code,{children:"@platformatic/client"})})," as a dependency:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm install @platformatic/client\n"})}),"\n",(0,i.jsx)(n.p,{children:"Now we can generate a client for the People service:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npx platformatic client --name people --runtime people-service --folder clients/people/\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We'll see that this has generated a new directory, ",(0,i.jsx)(n.code,{children:"clients/people/"}),", which contains a snapshot of the People service's OpenAPI schema and types that we can use when we integrate the client with our Media service. If we open up ",(0,i.jsx)(n.code,{children:"platformatic.composer.json"}),", we'll also see that a ",(0,i.jsx)(n.code,{children:"clients"})," block like this has been added:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'// services/media-service/platformatic.composer.json\n\n{\n  "$schema": "https://platformatic.dev/schemas/v0.28.1/composer",\n  ...,\n  "clients": [\n    {\n      "schema": "clients/people/people.openapi.json",\n      "name": "people",\n      "type": "openapi",\n      "serviceId": "people-service"\n    }\n  ],\n  ...\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This configuration will make the People service client available as ",(0,i.jsx)(n.code,{children:"app.people"})," inside any plugins that we create for our Media service."]}),"\n",(0,i.jsxs)(n.p,{children:["To create the skeleton structure for our plugin, let's create a new file, ",(0,i.jsx)(n.code,{children:"services/media-service/plugin.js"}),", and add the following code:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// services/media-service/plugin.js\n\n/// <reference path=\"./clients/people/people.d.ts\" />\n\n'use strict'\n\n/** @param {import('fastify').FastifyInstance} app */\nmodule.exports = async function peopleDataPlugin (app) {\n\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The code we've just added is the skeleton structure for our plugin. The ",(0,i.jsx)(n.code,{children:'<reference path="..." />'})," statement pulls in the types from the People client, providing us with type hinting and type checking (if it's supported by our code editor)."]}),"\n",(0,i.jsxs)(n.p,{children:["To be able to modify the responses that are sent from one of our Media service's composed API routes, we need to add a Composer ",(0,i.jsx)(n.code,{children:"onRoute"})," hook for the route, and then set an ",(0,i.jsx)(n.code,{children:"onComposerResponse"})," callback function inside of it, for example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"app.platformatic.addComposerOnRouteHook('/books/', ['GET'], function (routeOptions) {\n  routeOptions.config.onComposerResponse = function (request, reply, body) {\n    // ...\n  }\n})\n"})}),"\n",(0,i.jsxs)(n.p,{children:["With the code above, when Composer registers the ",(0,i.jsx)(n.code,{children:"GET"})," route for ",(0,i.jsx)(n.code,{children:"/books/"})," in the composed API, it will call the ",(0,i.jsx)(n.code,{children:"onRoute"})," hook function. Then when the Media service receives a response for that route from the downstream service, it will run our ",(0,i.jsx)(n.code,{children:"onComposerResponse"})," callback function. We can add code inside the ",(0,i.jsx)(n.code,{children:"onComposerResponse"})," which modifies the response that is returned back to the client that made the original request."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["To get a clearer picture of how this works, take a look at our ",(0,i.jsx)(n.a,{href:"https://docs.platformatic.dev/docs/reference/composer/api-modification/?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"Composer API modification"})," documentation."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Let's now apply what we've just learnt about Composer hooks and callbacks. First, let's add the following code inside of the ",(0,i.jsx)(n.code,{children:"peopleDataPlugin"})," function in ",(0,i.jsx)(n.code,{children:"services/media-service/plugin.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// services/media-service/plugin.js\n\nfunction buildOnComposerResponseCallback (peopleProps) {\n  return async function addPeopleToResponse (request, reply, body) {\n    let entities = await body.json()\n\n    const multipleEntities = Array.isArray(entities)\n    if (!multipleEntities) {\n      entities = [entities]\n    }\n\n    const peopleIds = []\n    for (const entity of entities) {\n      for (const { idProp } of peopleProps) {\n        peopleIds.push(entity[idProp])\n      }\n    }\n\n    const people = await app.people.getPeople({ \"where.id.in\": peopleIds.join(',') })\n\n    const getPersonNameById = (id) => {\n      const person = people.find(person => person.id === id)\n      return (person) ? person.name : null\n    }\n\n    for (let entity of entities) {\n      for (const { idProp, nameProp } of peopleProps) {\n        entity[nameProp] = getPersonNameById(entity[idProp])\n      }\n    }\n\n    reply.send(multipleEntities ? entities : entities[0])\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["There are a few moving parts in the code above, so let's break down what's happening. The ",(0,i.jsx)(n.code,{children:"buildOnComposerResponseCallback"})," function returns a function, which when called will:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Parse the JSON response body"}),"\n",(0,i.jsx)(n.li,{children:"Handle single or multiple entities"}),"\n",(0,i.jsx)(n.li,{children:"Extract the person IDs from the properties in the entities that contain them"}),"\n",(0,i.jsx)(n.li,{children:"Use the People client to retrieve people matching those IDs from the People service"}),"\n",(0,i.jsx)(n.li,{children:"Loop through each entity and adds new properties with the names for any people referenced by that entity"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Now, let's add this function after the ",(0,i.jsx)(n.code,{children:"buildOnComposerResponseCallback"})," function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// services/media-service/plugin.js\n\nfunction booksOnRouteHook (routeOptions) {\n  const responseSchema = routeOptions.schema.response[200]\n  const entitySchema = (responseSchema.items) ? responseSchema.items : responseSchema\n  entitySchema.properties.authorName = { type: 'string' }\n  entitySchema.required.push('authorName')\n\n  routeOptions.config.onComposerResponse = buildOnComposerResponseCallback([\n    { idProp: 'authorId', nameProp: 'authorName' }\n  ])\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["In the code above we're modifying the response schema for the route which the ",(0,i.jsx)(n.code,{children:"routeOptions"})," have been passed for. This ensures that the ",(0,i.jsx)(n.code,{children:"authorName"})," will be correctly serialized in the response from our Media service's ",(0,i.jsx)(n.code,{children:"/books/"})," routes."]}),"\n",(0,i.jsxs)(n.p,{children:["Then, we're registering an ",(0,i.jsx)(n.code,{children:"onComposerResponse"})," callback, which is the function that's returned by the ",(0,i.jsx)(n.code,{children:"buildOnComposerResponseCallback"})," that we added a little earlier. The ",(0,i.jsx)(n.code,{children:"peopleProps"})," array that we're passing to ",(0,i.jsx)(n.code,{children:"buildOnComposerResponseCallback"})," tells it to look for a person ID in the ",(0,i.jsx)(n.code,{children:"authorId"})," property for any book entity, and then to set the name that it retrieves for the person matching that ID to a property named ",(0,i.jsx)(n.code,{children:"authorName"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Finally, let's add this code after the ",(0,i.jsx)(n.code,{children:"booksOnRouteHook"})," function to wire everything up:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"app.platformatic.addComposerOnRouteHook('/books/', ['GET'], booksOnRouteHook)\napp.platformatic.addComposerOnRouteHook('/books/{id}', ['GET'], booksOnRouteHook)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now we can configure the Media service to load our new plugin. Let's open up ",(0,i.jsx)(n.code,{children:"platformatic.composer.json"})," and add a ",(0,i.jsx)(n.code,{children:"plugins"})," object to the service configuration:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "$schema": "https://platformatic.dev/schemas/v0.28.1/composer",\n  ...,\n  "plugins": {\n    "paths": [\n      "./plugin.js"\n    ]\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Now let's test our ",(0,i.jsx)(n.code,{children:"/books/"})," routes to see if the people data is being added to the responses:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3045/books/ | grep 'authorName'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We should see that each book in the JSON response now contains an ",(0,i.jsx)(n.code,{children:"authorName"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["If we make a request to retrieve the book with the ID ",(0,i.jsx)(n.code,{children:"1"}),", we should see that response also now contains an ",(0,i.jsx)(n.code,{children:"authorName"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3045/books/1 | grep 'authorName'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We're now going to add ",(0,i.jsx)(n.code,{children:"onRoute"})," hooks for our composed ",(0,i.jsx)(n.code,{children:"/movies/"})," routes. These hooks will add the names for the director and producer of each movie."]}),"\n",(0,i.jsxs)(n.p,{children:["First, let's add this function inside the ",(0,i.jsx)(n.code,{children:"peopleDataPlugin"}),", after the other code that's already there:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// services/media-service/plugin.js\n\nfunction moviesOnRouteHook (routeOptions) {\n  const responseSchema = routeOptions.schema.response[200]\n  const entitySchema = (responseSchema.items) ? responseSchema.items : responseSchema\n  entitySchema.properties.directorName = { type: 'string' }\n  entitySchema.properties.producerName = { type: 'string' }\n  entitySchema.required.push('directorName', 'producerName')\n\n  routeOptions.config.onComposerResponse = buildOnComposerResponseCallback([\n    { idProp: 'directorId', nameProp: 'directorName' },\n    { idProp: 'producerId', nameProp: 'producerName' }\n  ])\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Similarly to the ",(0,i.jsx)(n.code,{children:"booksOnRouteHook"})," function, the code above is modifying the response schema for the ",(0,i.jsx)(n.code,{children:"/movies/"})," routes to allow for two new properties: ",(0,i.jsx)(n.code,{children:"directorName"})," and ",(0,i.jsx)(n.code,{children:"producerName"}),". It's then registering an ",(0,i.jsx)(n.code,{children:"onComposerResponse"})," callback. That callback will pluck person IDs from the ",(0,i.jsx)(n.code,{children:"directorId"})," and ",(0,i.jsx)(n.code,{children:"producerId"})," properties in any movie entity, and then set the names for the corresponding people in the ",(0,i.jsx)(n.code,{children:"directorName"})," and ",(0,i.jsx)(n.code,{children:"producerName"})," properties."]}),"\n",(0,i.jsxs)(n.p,{children:["Finally, let's wire up the ",(0,i.jsx)(n.code,{children:"moviesOnRouteHook"})," to our ",(0,i.jsx)(n.code,{children:"/movies/"})," routes:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// services/media-service/plugin.js\n\napp.platformatic.addComposerOnRouteHook('/movies/', ['GET'], moviesOnRouteHook)\napp.platformatic.addComposerOnRouteHook('/movies/{id}', ['GET'], moviesOnRouteHook)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now we can test our ",(0,i.jsx)(n.code,{children:"/movies/"})," routes to confirm that the people data is being added to the responses:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3045/movies/ | grep 'Name'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Each movie in the JSON response should now contains a ",(0,i.jsx)(n.code,{children:"directorName"})," and a ",(0,i.jsx)(n.code,{children:"producerName"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["If we make a request to retrieve the movie with the ID ",(0,i.jsx)(n.code,{children:"3"}),", we should see that response also now contains a ",(0,i.jsx)(n.code,{children:"directorName"})," and a ",(0,i.jsx)(n.code,{children:"producerName"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3045/movies/3 | grep 'Name'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configure-a-service-proxy-to-debug-the-people-service-api",children:"Configure a service proxy to debug the People service API"}),"\n",(0,i.jsxs)(n.p,{children:["Our Media service is composing the Books and Movies services into an API, and the Media service is then exposed by the Library app. But what if we want to test or debug the People service API during development? Fortunately, Platformatic Composer provides a service proxy feature (",(0,i.jsx)(n.a,{href:"https://docs.platformatic.dev/docs/reference/composer/configuration#composer",children:(0,i.jsx)(n.code,{children:"services[].proxy"})}),") which we can use to help us do this."]}),"\n",(0,i.jsxs)(n.p,{children:["Let's try this out by adding another service to the ",(0,i.jsx)(n.code,{children:"services"})," in ",(0,i.jsx)(n.code,{children:"platformatic.composer.json"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:'// platformatic.composer.json\n\n  {\n    "$schema": "https://platformatic.dev/schemas/v0.28.1/composer",\n    ...,\n    "composer": {\n      "services": [\n        ...,\n        {\n          "id": "movies-service",\n          "openapi": {\n            "url": "/documentation/json",\n            "config": "movies-service-openapi.config.json"\n          }\n-       }\n+       },\n+       {\n+         "id": "people-service",\n+         "proxy": {\n+           "prefix": "people-service"\n+         }\n+       }\n      ],\n      "refreshTimeout": 1000\n    },\n    ...\n  }\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Now the People service API will be made available as part of the composed Media service API under the prefix ",(0,i.jsx)(n.code,{children:"/people-service/"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Let's test it now by making a request to one of the People service routes, via the composed Media service API:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl localhost:3045/people-service/people/\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We should receive a response like this from the People service's ",(0,i.jsx)(n.code,{children:"/people"})," route:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'[{"id":1,"name":"Stephen King","createdAt":"1687891503369","updatedAt":"1687891503369"},{"id":2,"name":"Miranda July","createdAt":"1687891503375","updatedAt":"1687891503375"},{"id":3,"name":"Lewis Carroll","createdAt":"1687891503377","updatedAt":"1687891503377"},{"id":4,"name":"Martha Schumacher","createdAt":"1687891503379","updatedAt":"1687891503379"},{"id":5,"name":"Mick Garris","createdAt":"1687891503381","updatedAt":"1687891503381"},{"id":6,"name":"Dede Gardner","createdAt":"1687891503383","updatedAt":"1687891503383"}]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Although the Composer service proxy is a helpful feature, we don't want to use this in production, so let's remove the configuration that we just added to ",(0,i.jsx)(n.code,{children:"platformatic.composer.json"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-diff",children:'// platformatic.composer.json\n\n  {\n    "$schema": "https://platformatic.dev/schemas/v0.28.1/composer",\n    ...,\n    "composer": {\n      "services": [\n        ...,\n        {\n          "id": "movies-service",\n          "openapi": {\n            "url": "/documentation/json",\n            "config": "movies-service-openapi.config.json"\n          }\n+       }\n-       },\n-       {\n-         "id": "people-service",\n-         "proxy": {\n-           "prefix": "people-service"\n-         }\n-       }\n      ],\n      "refreshTimeout": 1000\n    },\n    ...\n  }\n'})}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,i.jsx)(n.h3,{id:"integrating-existing-services-into-a-runtime-application",children:"Integrating existing services into a Runtime application"}),"\n",(0,i.jsx)(n.p,{children:"If you have existing services that aren't built with Platformatic or Fastify, there are two ways you can integrate them with the services in a Platformatic Runtime application:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"If the existing service provides an OpenAPI schema (via a URL or a file), you can create a Platformatic Composer service inside the Runtime application and configure it to add the API for the existing service into a composed API."}),"\n",(0,i.jsx)(n.li,{children:"If the existing service provides an OpenAPI or GraphQL schema, you can generate a Platformatic Client for the existing service. The generated client can then be integrated with one of the Runtime services."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"building-platformatic-runtime-services-in-a-monorepo",children:"Building Platformatic Runtime services in a monorepo"}),"\n",(0,i.jsxs)(n.p,{children:["Here at Platformatic we use a ",(0,i.jsx)(n.a,{href:"https://pnpm.io/?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"pnpm"})," workspace to manage our ",(0,i.jsx)(n.a,{href:"https://github.com/platformatic/platformatic/?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"platformatic"})," monorepo. If you want to build Platformatic Runtime services in a monorepo, you might want to take a look at ",(0,i.jsx)(n.a,{href:"https://pnpm.io/workspaces?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"pnpm workspaces"})," for managing your repository."]}),"\n",(0,i.jsxs)(n.p,{children:["You can configure your Runtime services as pnpm workspaces by adding a ",(0,i.jsx)(n.code,{children:"pnpm-workspace.yaml"})," file to your project like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"packages:\n  - 'services/*'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This allows you to then run scripts for all services, for example ",(0,i.jsx)(n.code,{children:"pnpm run -r migrate"}),". See the ",(0,i.jsx)(n.a,{href:"https://github.com/platformatic/examples/tree/main/applications/build-modular-monolith-with-platformatic?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog#readme",children:"example application README"})," for more details."]}),"\n",(0,i.jsx)(n.h2,{id:"wrapping-up",children:"Wrapping up"}),"\n",(0,i.jsxs)(n.p,{children:["If you've followed this tutorial step-by-step, you should now have a Platformatic Runtime app with four separate services that work together to provide a unified API. You can find the full application code ",(0,i.jsx)(n.a,{href:"https://github.com/platformatic/examples/tree/main/applications/build-modular-monolith-with-platformatic?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"on GitHub"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["You can watch Platformatic Runtime and Composer in action in the deep dive videos that our Co-founder and CTO ",(0,i.jsx)(n.a,{href:"https://twitter.com/matteocollina?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"Matteo Collina"})," created for our ",(0,i.jsx)(n.a,{href:"https://papilio.platformatic.dev/?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"Papilio Launch"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.youtube.com/watch?v=KGzAURD8mcc&list=PL_x4nRdxj60K1zx4pCOEXUTQKkDg8WpCR&index=2?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"Introducing: Platformatic Runtime"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.youtube.com/watch?v=0DeNIeSnH0E&list=PL_x4nRdxj60K1zx4pCOEXUTQKkDg8WpCR&index=3?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"Introducing: Platformatic Composer"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.youtube.com/watch?v=W_bXefh-j4A&list=PL_x4nRdxj60K1zx4pCOEXUTQKkDg8WpCR&index=4?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"Introducing: Client & Taxonomy"})}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"get-started-with-platformatic",children:"Get started with Platformatic"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Build robust Node.js apps with ",(0,i.jsx)(n.a,{href:"https://docs.platformatic.dev/?utm_campaign=Blog%20post%20-%20Building%20REST%20APIs%20with%20Platformatic%20DB&utm_medium=blog&utm_source=Platformatic%20Blog?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"our open-source tools"})]}),"\n",(0,i.jsxs)(n.li,{children:["Join ",(0,i.jsx)(n.a,{href:"https://discord.gg/platformatic?utm_campaign=Blog%20post%20-%20Building%20REST%20APIs%20with%20Platformatic%20DB&utm_medium=blog&utm_source=Platformatic%20Blog?utm_campaign=Build%20and%20deploy%20a%20modular%20monolith%20with%20Platformatic&utm_medium=blog&utm_source=Platformatic%20Blog",children:"our community"})," on Discord"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},2165:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/architecture-diagram-fed017834dc01179a39d0683174dc939.png"},6545:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/make-the-composed-media-service-api-read-only-01-da313b5e8ff9c9f51c0eda1b9fa4063f.png"},9061:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/start-the-runtime-app-01-bf5c8d6056b38cd4dfabe4e6783a15c7.png"},5240:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/test-the-books-service-api-01-bd7a2579eaaa6acecd7c923c642e3fb8.png"},3919:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/test-the-composed-media-service-api-01-1446913047e577b38d09aab49a405a82.png"},2500:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/test-the-movies-service-api-01-cd919b81378e1603e268985154ea7139.png"},4148:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/test-the-people-service-01-c934fd30863aaeb99048b70e9dab00d0.png"},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>a});var i=s(6540);const o={},t=i.createContext(o);function r(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);